<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Music • Yae Yadir</title>
<link rel="icon" href="favicon.ico">
<style>
    @font-face {
      font-family: 'sitefont';
      src: url('beyoncefont.ttf') format('truetype');
      font-weight: normal;
      font-style: normal;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0; height: 100%; width: 100%;
      font-family: 'sitefont', monospace;
      background-color: black; color: white;
      text-transform: uppercase;
    }
    body { display: flex; flex-direction: row; min-height: 100vh; overflow: hidden; }

    /* TOPBAR (mobile only) */
    .topbar {
      display: none; align-items: center; justify-content: flex-start;
      padding: 10px; background-color: black; border-bottom: 1px solid #333;
      width: 100%; position: fixed; top: 0; left: 0; z-index: 1001;
    }
    .hamburger { font-size: 24px; cursor: pointer; margin-right: 10px; }
    .top-name { font-size: 24px; flex: 1; text-align: center; }

    /* SIDEBAR */
    .sidebar {
      width: 250px; height: 100vh; background-color: black; padding: 20px;
      display: flex; flex-direction: column; align-items: center;
      border-right: 1px solid #333; gap: 20px;
    }
    .profile-img { width: 120px; height: 120px; border-radius: 50%; object-fit: cover; border: 2px solid #fff; }
    .name { font-size: 24px; letter-spacing: 2px; text-align: center; }

    /* MINI PLAYER */
    .mini-player {
      width: 100%; padding: 16px; background: rgba(255,255,255,0.04);
      border: 1px solid #333; border-radius: 12px; display: flex;
      flex-direction: column; gap: 10px;
    }
    .now-playing-title {
      font-size: 12px; color: #aaa; white-space: nowrap; overflow: hidden;
      text-overflow: ellipsis; text-align: center; letter-spacing: 1px;
    }
    .mini-controls { display: flex; justify-content: center; gap: 20px; align-items: center; }
    .mini-btn { background: none; border: none; color: #fff; font-size: 20px;
      cursor: pointer; padding: 4px; opacity: 0.8; transition: all 0.2s; }
    .mini-btn:hover { opacity: 1; transform: scale(1.1); }
    .mini-btn.main { font-size: 32px; opacity: 1; }

    .buttons { display: flex; flex-direction: column; gap: 10px; width: 100%; }
    .button {
      background-color: black; border: 1px solid #666; color: white;
      padding: 15px; text-align: center; cursor: pointer; font-size: 14px;
      letter-spacing: 1px; transition: border-color 0.3s ease; text-decoration: none; display: block;
    }
    .button:hover { border-color: #999; }

    .footer {
      font-size: 10px; text-align: center; opacity: 0.7;
      display: flex; flex-wrap: wrap; justify-content: center; gap: 5px;
      margin-top: 20px; width: 100%;
    }
    .footer a { color: white; text-decoration: none; font-size: 10px; }
    .footer a:hover { opacity: 0.5; }
    .footer-dot { opacity: 0.7; }
    .copyright { font-size: 8px; margin-top: 5px; width: 100%; }

    /* MAIN CONTENT */
    .main-content { flex: 1; overflow-y: auto; padding: 20px; height: 100vh; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin: 32px 0 16px; }
    h2.section { font-size: 20px; letter-spacing: .18em; opacity: .9; margin: 0; }
    .show-more-btn {
      background: none; border: 1px solid #555; color: #aaa;
      padding: 6px 12px; border-radius: 999px; font-size: 11px;
      cursor: pointer; letter-spacing: 1px; transition: all 0.2s ease;
    }
    .show-more-btn:hover { border-color: #999; color: white; }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; margin-top: 10px;
    }

    /* ────────────────────── MUSIC VIDEOS (EXACTLY LIKE YOUR IMAGE) ────────────────────── */
    #gridVideos {
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
      gap: 32px;
      margin-top: 24px;
    }
    .video-header {
      font-size: 42px !important;
      letter-spacing: 0.12em;
      text-align: center;
      margin: 60px 0 40px !important;
      opacity: 1;
    }
    .video-card {
      cursor: pointer;
      background: #111;
      border-radius: 20px;
      overflow: hidden;
      transition: transform 0.25s ease;
    }
    .video-card:hover { transform: scale(1.04); }
    .video-thumb {
      position: relative;
      aspect-ratio: 16 / 9;
      background: #000;
      overflow: hidden;
    }
    .video-thumb img {
      width: 100%; height: 100%; object-fit: cover;
      transition: opacity 0.3s;
    }
    .video-card:hover .video-thumb img { opacity: 0.85; }
    .video-thumb::after {
      content: 'Play';
      position: absolute;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      font-size: 72px;
      color: rgba(255,255,255,0.9);
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }
    .video-card:hover .video-thumb::after { opacity: 1; }

    .video-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px 20px;
    }
    .video-title {
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 0.8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 70%;
    }
    .video-year {
      font-size: 15px;
      color: #999;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .video-year::before {
      content: 'Play';
      font-size: 14px;
      opacity: 0.7;
    }

    /* Original card styles (albums, singles, etc.) */
    .card { cursor: pointer; }
    .thumb { aspect-ratio: 1/1; border-radius: 8px; background: #101015; overflow: hidden; position: relative; }
    .thumb img { width: 100%; height: 100%; object-fit: cover; }
    .thumb .hover { position: absolute; inset: 0; background: rgba(255,255,255,.06); opacity: 0; transition: .18s; }
    .card:hover .hover { opacity: 1; }
    .meta { padding: 8px 2px 0; }
    .title { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .subtitle { font-size: 12px; color: #aaa; margin-top: 2px; }

    /* Detail page & mobile styles (unchanged) */
    .view { display: none; width: 100%; }
    .view.active { display: block; }
    .detail-head { display: grid; grid-template-columns: 260px 1fr; gap: 24px; margin-top: 18px; }
    @media(max-width:820px) { .detail-head { grid-template-columns: 1fr; gap: 16px; } }
    .art-lg { width: 100%; aspect-ratio: 1/1; border-radius: 8px; background: #101015; object-fit: cover; }
    .d-title { font-size: 40px; line-height: 1.08; margin: 4px 0 6px; letter-spacing: .02em; }
    .d-artist { color: #aaa; }
    .chips { display: flex; gap: 10px; align-items: center; margin: 12px 0 10px; color: #aaa; }
    .chip { font-size: 12px; padding: 6px 10px; border: 1px solid #555; border-radius: 999px; }
    .btn { border: 1px solid #555; background: #fff; color: #000; padding: 10px 16px; border-radius: 999px; font-weight: 700; letter-spacing: .12em; font-size: 12px; cursor: pointer; }
    .btn.alt { background: transparent; color: #fff; }
    .tracks { margin-top: 20px; border-top: 1px solid #555; }
    .row { display: grid; grid-template-columns: 36px 1fr 70px 28px; gap: 12px; align-items: center; padding: 12px 6px; border-bottom: 1px solid #555; cursor: pointer; }
    .row .idx { color: #888; text-align: right; }
    .row .tname { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .row .etime { color: #888; font-variant-numeric: tabular-nums; }
    .row .dots { color: #888; text-align: center; }
    .row.playing { background: rgba(255,255,255,.06); }
    .row:hover { background: rgba(255,255,255,.04); }

    /* MOBILE */
    @media (max-width: 768px) {
      body { flex-direction: column; height: auto; min-height: 100vh; padding-top: 50px; padding-bottom: 80px; overflow: auto; }
      .topbar { display: flex; }
      .sidebar { display: none; position: absolute; top: 50px; left: 0; width: 100%; height: auto; padding: 20px; background-color: black; z-index: 999; border-bottom: 1px solid #333; }
      .sidebar.active { display: flex; }
      .main-content { height: auto; overflow-y: visible; padding: 10px; }
      .detail-head { grid-template-columns: 1fr; gap: 16px; }
      .d-title { font-size: 32px; }
      .grid { grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 16px; }
      h2.section { font-size: 18px; }
      .show-more-btn { font-size: 10px; padding: 4px 8px; }
      .mini-player { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1002; background-color: black; border: none; border-top: 1px solid #333; border-radius: 0; padding: 10px; }
      .now-playing-title { font-size: 10px; }
      .mini-btn { font-size: 18px; }
      .mini-btn.main { font-size: 28px; }

      /* Mobile video tweaks */
      #gridVideos { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)) !important; gap: 24px; }
      .video-header { font-size: 32px !important; margin: 40px 0 30px !important; }
      .video-thumb::after { font-size: 56px; }
      .video-title { font-size: 16px; }
    }
</style>
</head>
<body class="dark-mode">
  <div class="topbar">
    <span class="hamburger">&#9776;</span>
    <h1 class="top-name">PLAYER</h1>
  </div>

  <!-- Sidebar -->
  <div class="sidebar">
    <img class="profile-img" src="IMG_6877.jpeg" alt="YAE YADIR" />
    <h1 class="name"><a href="index.html" style="color: white; text-decoration: none;">YAE YADIR</a></h1>
    <div class="mini-player">
      <div class="now-playing-title" id="nowPlayingTitle">No track playing</div>
      <div class="mini-controls">
        <button id="prevBtn" class="mini-btn">⏮</button>
        <button id="playPauseBtn" class="mini-btn main">▶︎</button>
        <button id="nextBtn" class="mini-btn">⏭</button>
      </div>
    </div>
    <div class="buttons">
      <a href="index.html" class="button">GALLERY</a>
      <a href="music.html" class="button">LATEST ALBUM</a>
      <a href="portfolio.html" class="button">PORTFOLIO</a>
      <a href="podcast.html" class="button">PODCAST</a>
      <a href="#" class="button">COMING SOON</a>
    </div>
    <div class="footer">
      <a href="https://mystery.k1llajay.com">MYSTERY</a><span class="footer-dot"> • </span>
      <a href="database.html">MUSIC DATABASE</a><span class="footer-dot"> • </span>
      <a href="god-is-the-plan.html">GOD IS THE PLAN</a><span class="footer-dot"> • </span>
      <a href="terms-and-conditions.html">TERMS</a><span class="footer-dot"> • </span>
      <a href="privacy-policy.html">PRIVACY</a>
      <div class="copyright">© 2025 JEFFERSON ENTERTAINMENT LLC</div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <section id="viewLibrary" class="view active">
      <div class="section-header">
        <h2 class="section">Albums</h2>
        <button class="show-more-btn" data-target="gridAlbums">Show More</button>
      </div>
      <div id="gridAlbums" class="grid"></div>

      <div class="section-header">
        <h2 class="section">Music Videos</h2>
        <button class="show-more-btn" data-target="gridVideos">Show More</button>
      </div>
      <div id="gridVideos" class="grid"></div>

      <div class="section-header">
        <h2 class="section">Singles &amp; EPs</h2>
        <button class="show-more-btn" data-target="gridSingles">Show More</button>
      </div>
      <div id="gridSingles" class="grid"></div>

      <div class="section-header" id="compHeader" style="display:none">
        <h2 class="section">Compilations</h2>
        <button class="show-more-btn" data-target="gridCompilations">Show More</button>
      </div>
      <div id="gridCompilations" class="grid" style="display:none"></div>
    </section>

    <section id="viewDetail" class="view">
      <button id="backBtn" class="btn alt" style="margin-bottom:10px">← Library</button>
      <div class="detail-head">
        <img id="detailArt" class="art-lg" src="" alt="">
        <div>
          <div class="d-title" id="detailTitle">—</div>
          <div class="d-artist">Yae Yadir</div>
          <div class="chips">
            <span id="detailType" class="chip">EP</span>
            <span id="detailYear" class="chip">2025</span>
          </div>
          <div style="display:flex; gap:16px; margin:20px 0;">
            <button id="playAllBtn" class="btn">Play All</button>
            <button id="shuffleBtn" class="btn alt">Shuffle</button>
          </div>
          <div class="tracks" id="tracks"></div>
          <div class="mini-note" id="detailNote"></div>
          <div class="foot" id="detailFoot"></div>
        </div>
      </div>
    </section>
  </div>

  <audio id="audio" preload="metadata"></audio>

  <!-- Firebase + Full Script (only createCard changed) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDQwlDjIGA2whvBDhOeLrnseQB4EoP7EcA",
      authDomain: "mainsite-eb919.firebaseapp.com",
      databaseURL: "https://mainsite-eb919-default-rtdb.firebaseio.com",
      projectId: "mainsite-eb919",
      storageBucket: "mainsite-eb919.firebasestorage.app",
      messagingSenderId: "799554641103",
      appId: "1:799554641103:web:f23b774cbb08e03aebebba"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const storage = firebase.storage();

    const audio = document.getElementById('audio');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const nowPlayingTitle = document.getElementById('nowPlayingTitle');
    const playAllBtn = document.getElementById('playAllBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const backBtn = document.getElementById('backBtn');

    let LIB = [], GROUPS = {}, CURRENT_RELEASE = null, QUEUE = [], INDEX = 0;

    function getMaxVisible() {
      if (window.innerWidth <= 640) return 3;
      if (window.innerWidth <= 1024) return 5;
      return 10;
    }
    function el(tag, cls, html) {
      const e = document.createElement(tag);
      if (cls) e.className = cls;
      if (html !== undefined) e.innerHTML = html;
      return e;
    }
    const fmt = s => isFinite(s) && s > 0 ? Math.floor(s/60) + ':' + String(Math.floor(s%60)).padStart(2,'0') : '0:00';

    async function resolveUrlMaybe(p) {
      if (!p) return '';
      if (/^https?:\/\//i.test(p)) return p;
      try { return await storage.ref(p).getDownloadURL(); } catch { return ''; }
    }

    function updateNowPlaying() {
      if (!QUEUE.length || !LIB[QUEUE[INDEX]]) {
        nowPlayingTitle.textContent = "No track playing";
        document.title = "Music • Yae Yadir";
        return;
      }
      const track = LIB[QUEUE[INDEX]];
      nowPlayingTitle.textContent = `${track.title} • Yae Yadir • ${track.releaseTitle}`;
      document.title = `${track.title} • Yae Yadir • ${track.releaseTitle}`;
    }
    function updatePlayIcon() {
      playPauseBtn.innerHTML = audio.paused ? '▶' : '⏸';
    }

    function playIndex(idx, auto = true) {
      if (!QUEUE.length) return;
      INDEX = (idx + QUEUE.length) % QUEUE.length;
      const track = LIB[QUEUE[INDEX]];
      if (!track) return;
      audio.src = track.audioUrl;
      if (auto) audio.play().catch(() => {});
      else audio.load();
      updateNowPlaying();
      updatePlayIcon();
      highlightPlayingTrack();
    }
    function playFromRelease(startIdx = 0) {
      if (!CURRENT_RELEASE) return;
      QUEUE = [...CURRENT_RELEASE.tracks];
      playIndex(startIdx);
    }
    function highlightPlayingTrack() {
      if (!CURRENT_RELEASE) return;
      const currentLibIdx = QUEUE[INDEX];
      const relIndex = CURRENT_RELEASE.tracks.indexOf(currentLibIdx);
      document.querySelectorAll('#tracks .row').forEach((row, i) => {
        row.classList.toggle('playing', i === relIndex);
      });
    }

    playPauseBtn.onclick = () => {
      if (!audio.src && CURRENT_RELEASE) playFromRelease(0);
      else if (audio.paused) audio.play().catch(() => {});
      else audio.pause();
    };
    prevBtn.onclick = () => { if (audio.currentTime > 3) audio.currentTime = 0; else playIndex(INDEX - 1); };
    nextBtn.onclick = () => playIndex(INDEX + 1);
    playAllBtn.onclick = () => playFromRelease(0);
    shuffleBtn.onclick = () => {
      if (!CURRENT_RELEASE) return;
      QUEUE = [...CURRENT_RELEASE.tracks].sort(() => Math.random() - 0.5);
      playIndex(0);
    };
    backBtn.onclick = () => {
      document.getElementById('viewDetail').classList.remove('active');
      document.getElementById('viewLibrary').classList.add('active');
    };
    audio.addEventListener('play', updatePlayIcon);
    audio.addEventListener('pause', updatePlayIcon);
    audio.addEventListener('ended', () => {
      if (INDEX < QUEUE.length - 1) playIndex(INDEX + 1);
      else { audio.pause(); updatePlayIcon(); }
    });

    // ──────── UPDATED createCard (Video cards now match your screenshot) ────────
    function createCard(release) {
      if (release.type === 'Video') {
        const card = el('div', 'video-card');
        const thumb = el('div', 'video-thumb');
        const img = el('img');
        img.src = release.coverUrl || '';
        img.alt = release.name;
        thumb.appendChild(img);

        const meta = el('div', 'video-meta');
        const title = el('div', 'video-title', release.name || 'Untitled Video');
        const year = el('div', 'video-year', release.year || '');

        meta.append(title, year);
        card.append(thumb, meta);
        card.onclick = () => openRelease(release.key);
        return card;
      }

      // Regular album/single card
      const card = el('div', 'card');
      const thumb = el('div', 'thumb');
      const img = el('img');
      img.src = release.coverUrl || '';
      img.alt = release.name;
      thumb.append(img, el('div', 'hover'));

      const meta = el('div', 'meta');
      meta.append(
        el('div', 'title', release.name || 'Untitled'),
        el('div', 'subtitle', release.year || (release.releaseTs ? new Date(release.releaseTs).getUTCFullYear() : ''))
      );
      card.append(thumb, meta);
      card.onclick = () => openRelease(release.key);
      return card;
    }

    function limitGrid(gridEl, items, btn) {
      gridEl.innerHTML = '';
      const total = items.length;
      const maxVisible = getMaxVisible();
      const toShow = total > maxVisible ? maxVisible : total;
      items.slice(0, toShow).forEach(rel => gridEl.appendChild(createCard(rel)));
      if (total > maxVisible) {
        btn.style.display = 'block';
        btn.textContent = `Show More (${total - toShow} hidden)`;
        btn.onclick = () => {
          gridEl.innerHTML = '';
          items.forEach(rel => gridEl.appendChild(createCard(rel)));
          btn.textContent = 'Show Less';
          btn.onclick = () => limitGrid(gridEl, items, btn);
        };
      } else {
        btn.style.display = 'none';
      }
    }

    function renderLibrary() {
      const grids = {
        gridAlbums: document.getElementById('gridAlbums'),
        gridSingles: document.getElementById('gridSingles'),
        gridCompilations: document.getElementById('gridCompilations'),
        gridVideos: document.getElementById('gridVideos')
      };
      const albums = [], singlesEPs = [], videos = [], compilations = [];
      Object.values(GROUPS).forEach(rel => {
        if (rel.type === 'Video') videos.push(rel);
        else if (rel.type === 'Compilation') compilations.push(rel);
        else if (['Single', 'EP'].includes(rel.type)) singlesEPs.push(rel);
        else albums.push(rel);
      });
      const sortNewest = (a, b) => (b.releaseTs || 0) - (a.releaseTs || 0);
      [albums, singlesEPs, videos, compilations].forEach(arr => arr.sort(sortNewest));

      limitGrid(grids.gridAlbums, albums, document.querySelector('[data-target="gridAlbums"]'));
      limitGrid(grids.gridVideos, videos, document.querySelector('[data-target="gridVideos"]'));
      limitGrid(grids.gridSingles, singlesEPs, document.querySelector('[data-target="gridSingles"]'));
      limitGrid(grids.gridCompilations, compilations, document.querySelector('[data-target="gridCompilations"]'));

      const hasComp = compilations.length > 0;
      document.getElementById('compHeader').style.display = hasComp ? 'flex' : 'none';
      grids.gridCompilations.style.display = hasComp ? 'grid' : 'none';
    }

    function openRelease(key) {
      const rel = GROUPS[key];
      if (!rel) return;
      CURRENT_RELEASE = rel;
      document.getElementById('detailArt').src = rel.coverUrl || '';
      document.getElementById('detailTitle').textContent = rel.name || '—';
      document.getElementById('detailType').textContent = rel.type || 'EP';
      document.getElementById('detailYear').textContent = rel.year || (rel.releaseTs ? new Date(rel.releaseTs).getUTCFullYear() : '');
      document.getElementById('detailNote').textContent = `${rel.tracks.length} song${rel.tracks.length === 1 ? '' : 's'}`;
      document.getElementById('detailFoot').textContent = `© ${rel.year || new Date().getFullYear()} Jefferson Records LLC • Owned by Je’Veon Jefferson`;

      const tracksContainer = document.getElementById('tracks');
      tracksContainer.innerHTML = '';
      rel.tracks.forEach((libIdx, i) => {
        const t = LIB[libIdx];
        if (!t) return;
        const row = el('div', 'row');
        row.innerHTML = `
          <div class="idx">${t.trackNumber || (i + 1)}</div>
          <div class="tname">${t.title}</div>
          <div class="etime">${t.duration ? fmt(t.duration) : ''}</div>
          <div class="dots">...</div>
        `;
        row.onclick = () => playFromRelease(i);
        tracksContainer.appendChild(row);
      });

      document.getElementById('viewLibrary').classList.remove('active');
      document.getElementById('viewDetail').classList.add('active');
      highlightPlayingTrack();
    }

    async function hydrateTrack(raw) {
      const audioUrl = await resolveUrlMaybe(raw.audioUrl || raw.audioPath || raw.storagePath);
      const coverUrl = await resolveUrlMaybe(raw.coverUrl || raw.coverPath);
      const releaseTs = raw.releaseDate ? Date.parse(raw.releaseDate) : Number(raw.createdAt || 0);
      return {
        title: raw.title || raw.name || 'Untitled',
        artist: raw.artist || 'Yae Yadir',
        duration: Number(raw.duration || 0),
        trackNumber: Number(raw.trackNumber || raw.track || raw.no || 0),
        releaseTitle: (raw.releaseTitle || raw.group || '').trim(),
        releaseType: (raw.releaseType || '').trim(),
        year: raw.year || (releaseTs ? new Date(releaseTs).getUTCFullYear() : ''),
        releaseTs,
        coverUrl,
        audioUrl
      };
    }

    function buildGroups() {
      GROUPS = {};
      const temp = new Map();
      const coverMap = new Map();
      LIB.forEach((t, i) => {
        const key = t.releaseTitle || `__solo_${i}`;
        if (!temp.has(key)) temp.set(key, []);
        temp.get(key).push(i);
        if (t.coverUrl) {
          if (!coverMap.has(t.coverUrl)) coverMap.set(t.coverUrl, new Set());
          coverMap.get(t.coverUrl).add(key);
        }
      });
      const parent = new Map();
      const find = k => parent.has(k) ? find(parent.get(k)) : k;
      const union = (a, b) => { const pa = find(a), pb = find(b); if (pa !== pb) parent.set(pb, pa); };
      for (const keys of coverMap.values()) {
        const arr = [...keys];
        for (let i = 1; i < arr.length; i++) union(arr[0], arr[i]);
      }
      const merged = new Map();
      for (const [k, idxs] of temp) {
        const root = find(k);
        if (!merged.has(root)) merged.set(root, []);
        merged.get(root).push(...idxs);
      }
      for (const idxs of merged.values()) {
        idxs.sort((a, b) => (LIB[a].trackNumber || 0) - (LIB[b].trackNumber || 0) || LIB[a].createdAt - LIB[b].createdAt);
        const coverUrl = LIB[idxs.find(i => LIB[i].coverUrl)]?.coverUrl || '';
        const releaseTs = Math.max(...idxs.map(i => LIB[i].releaseTs || 0));
        const year = LIB[idxs.find(i => LIB[i].year)]?.year || (releaseTs ? new Date(releaseTs).getUTCFullYear() : '');
        const type = ['Video', 'Compilation', 'Album', 'EP', 'Single'].find(t => idxs.some(i => LIB[i].releaseType === t)) || (idxs.length > 6 ? 'Album' : 'EP');
        const name = [...new Set(idxs.map(i => LIB[i].releaseTitle).filter(Boolean))][0] || 'Untitled Release';
        const key = `${name}__${year}__${coverUrl.split('/').pop() || 'nocover'}`;
        GROUPS[key] = { key, name, type, year, artist: 'Yae Yadir', coverUrl, tracks: idxs, releaseTs };
      }
    }

    async function load() {
      try {
        const snap = await db.ref('songs').once('value');
        const data = snap.val() || {};
        const raw = Object.entries(data).map(([k, v]) => ({ ...v, key: k }));
        const hydrated = await Promise.all(raw.map(hydrateTrack));
        LIB = hydrated.filter(t => t.audioUrl);
        buildGroups();
        renderLibrary();
        updateNowPlaying();
        updatePlayIcon();
      } catch (e) {
        console.error("Load failed:", e);
      }
    }
    load();

    window.addEventListener('resize', () => {
      if (document.getElementById('viewLibrary').classList.contains('active')) renderLibrary();
    });

    const hamburger = document.querySelector('.hamburger');
    const sidebar = document.querySelector('.sidebar');
    hamburger.addEventListener('click', () => sidebar.classList.toggle('active'));

    window.addEventListener('load', () => {
      if (window.innerWidth <= 768) {
        const player = document.querySelector('.mini-player');
        document.body.appendChild(player);
      }
    });
  </script>
</body>
</html>